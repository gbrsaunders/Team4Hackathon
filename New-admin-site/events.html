<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Societies Admin – Events</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="admin.css" />
</head>
<body>
  <header class="topbar">
    <div class="topbar-brand">Societies Admin</div>

    <img src="lei-logo.png" alt="University of Leicester" class="topbar-logo" />

    <nav class="topbar-nav">
      <a class="topbar-link" href="societies.html">Societies</a>
      <a class="topbar-link" href="members.html">Members</a>
      <a class="topbar-link active" href="events.html">Events</a>
      <a class="topbar-link" href="announcements.html">Announcements</a>
    </nav>
  </header>

  <main class="main">
    <h2 class="page-title" id="events-page-title">Events</h2>
    <p class="page-subtitle" id="events-page-subtitle">
      Create and manage events for each society.
    </p>

    <div class="panel">
      <label>
        Select Society
        <select id="events-society-select"></select>
      </label>

      <table>
        <thead>
          <tr>
            <th>Title</th>
            <th>Date</th>
            <th>Time</th>
            <th>Location</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="events-table-body"></tbody>
      </table>
    </div>

    <div class="panel">
      <h3 id="event-form-title">Add Event</h3>
      <form id="event-form">
        <label>
          Title
          <input type="text" id="event-title" required />
        </label>
        <label>
          Date
          <input type="date" id="event-date" required />
        </label>
        <label>
          Time
          <input type="time" id="event-time" required />
        </label>
        <label>
          Location
          <input type="text" id="event-location" />
        </label>
        <label>
          Description
          <textarea id="event-description" rows="3"></textarea>
        </label>
        <div class="form-actions">
          <button type="submit" class="btn btn-primary">Save Event</button>
          <button type="button" class="btn btn-soft" id="event-cancel-btn">Cancel</button>
        </div>
      </form>
    </div>
  </main>

  <script src="data.js"></script>
  <script>
    let societyData = loadSocietyData();
    let currentSociety = null;
    let editingIndex = null;

    const selectEl = document.getElementById("events-society-select");
    const tableBody = document.getElementById("events-table-body");
    const titleEl = document.getElementById("events-page-title");
    const subtitleEl = document.getElementById("events-page-subtitle");

    const form = document.getElementById("event-form");
    const formTitle = document.getElementById("event-form-title");
    const cancelBtn = document.getElementById("event-cancel-btn");

    const inputTitle = document.getElementById("event-title");
    const inputDate = document.getElementById("event-date");
    const inputTime = document.getElementById("event-time");
    const inputLocation = document.getElementById("event-location");
    const inputDescription = document.getElementById("event-description");

    function getSocietyFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get("society");
    }

    function setSocietyInUrl(name) {
      const params = new URLSearchParams(window.location.search);
      params.set("society", name);
      const newUrl = window.location.pathname + "?" + params.toString();
      window.history.replaceState({}, "", newUrl);
    }

    function ensureEventsArray(name) {
      const info = societyData[name];
      if (!info.events) info.events = [];
    }

    function populateSocietySelect() {
      selectEl.innerHTML = "";
      Object.keys(societyData).forEach((name) => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        selectEl.appendChild(opt);
      });
    }

    function renderEvents() {
      societyData = loadSocietyData();
      if (!currentSociety || !societyData[currentSociety]) return;

      ensureEventsArray(currentSociety);
      const info = societyData[currentSociety];
      const events = info.events || [];
      tableBody.innerHTML = "";

      events
        .slice()
        .sort((a, b) => {
          const d1 = (a.date || "") + " " + (a.time || "");
          const d2 = (b.date || "") + " " + (b.time || "");
          return d1.localeCompare(d2);
        })
        .forEach((ev, index) => {
          const tr = document.createElement("tr");
          tr.dataset.index = index;
          tr.innerHTML = `
            <td>${ev.title}</td>
            <td>${ev.date || ""}</td>
            <td>${ev.time || ""}</td>
            <td>${ev.location || ""}</td>
            <td>
              <button class="btn btn-small btn-outline" data-action="edit-event">Edit</button>
              <button class="btn btn-small btn-danger" data-action="delete-event">Delete</button>
            </td>
          `;
          tableBody.appendChild(tr);
        });

      titleEl.textContent = `Events – ${currentSociety}`;
      subtitleEl.textContent =
        info.description || "Create and manage events for this society.";
    }

    function resetForm() {
      form.reset();
      editingIndex = null;
      formTitle.textContent = "Add Event";
    }

    function initEventsPage() {
      societyData = loadSocietyData();
      const names = Object.keys(societyData);
      if (!names.length) return;

      populateSocietySelect();

      const fromUrl = getSocietyFromUrl();
      if (fromUrl && societyData[fromUrl]) {
        currentSociety = fromUrl;
      } else {
        currentSociety = names[0];
      }

      ensureEventsArray(currentSociety);
      selectEl.value = currentSociety;
      renderEvents();
    }

    selectEl.addEventListener("change", () => {
      const value = selectEl.value;
      if (!value) return;
      currentSociety = value;
      ensureEventsArray(currentSociety);
      setSocietyInUrl(value);
      resetForm();
      renderEvents();
    });

    form.addEventListener("submit", (e) => {
      e.preventDefault();
      societyData = loadSocietyData();
      if (!currentSociety || !societyData[currentSociety]) return;

      ensureEventsArray(currentSociety);
      const info = societyData[currentSociety];

      const ev = {
        title: inputTitle.value.trim(),
        date: inputDate.value,
        time: inputTime.value,
        location: inputLocation.value.trim(),
        description: inputDescription.value.trim()
      };

      if (!ev.title || !ev.date || !ev.time) return;

      if (editingIndex === null) {
        info.events.push(ev);
      } else {
        info.events[editingIndex] = ev;
      }

      saveSocietyData(societyData);
      resetForm();
      renderEvents();
    });

    cancelBtn.addEventListener("click", () => {
      resetForm();
    });

    document.addEventListener("click", (e) => {
      const row = e.target.closest("tr");
      if (!row) return;
      const index = parseInt(row.dataset.index, 10);
      if (isNaN(index)) return;

      if (e.target.dataset.action === "edit-event") {
        societyData = loadSocietyData();
        const info = societyData[currentSociety];
        ensureEventsArray(currentSociety);
        const ev = info.events[index];
        if (!ev) return;

        editingIndex = index;
        formTitle.textContent = "Edit Event";
        inputTitle.value = ev.title || "";
        inputDate.value = ev.date || "";
        inputTime.value = ev.time || "";
        inputLocation.value = ev.location || "";
        inputDescription.value = ev.description || "";
        window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
      }

      if (e.target.dataset.action === "delete-event") {
        if (!confirm("Delete this event?")) return;
        societyData = loadSocietyData();
        const info = societyData[currentSociety];
        ensureEventsArray(currentSociety);
        info.events.splice(index, 1);
        saveSocietyData(societyData);
        resetForm();
        renderEvents();
      }
    });

    initEventsPage();
  </script>
</body>
</html>
